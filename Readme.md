# Cache开发说明

当前目录下为成品的ICache与半成品的DCache。目前ICache支持双发，具体更新见Cache_Design.md

ICache与DCache的输入输出接口已经非常接近成品，能够支持完成全部的功能，进行完整的接口配置。ICache其内部功能已经初步仿真正确，可综合验证。DCache的功能**没有**仿真验证，但是目前可综合。接口和写缓存都已经仿真通过。

我们很高兴，Cache的功能性开发来到了最后一步：DCache仿真验证。在仿真成功之后我们将正式迈入Beta v1.0，我们很期待即将到来的功能测试正确的版本，也就是Cache v1.0。看着这样一个结构优美有条理，并且同时进行了精心设计和优化考虑的Cache成功运行无疑是件兴奋的事情。接下来我们让好戏发生，望大家驻足等待。

由于本人英文水平差，又硬凑，代码里面中英注释夹杂，实属抱歉，由于中文容易乱码，之后尽量采用英文注释。

这tm？太夸张了吧，我DCache还没仿真就发现一堆逻辑错误，真就人体debug机器吗？还有一堆命名遗留错误，等跑通了再改吧！奥里给！

我发现如果同时出现两条访存指令，我就鸭屎了，但是这种不应该出现的阻塞可以通过流水来完成，所以将功能完成之后应该将这方面的修改放到第一优先级。

#### 流水线思考

DCache的一部分遗留问题如下：首先是结构和状态机不能够与流水线进行对接，同时整个流水线的结构显得扑朔迷离，不仅如此，当前的代码和数据通路的构造显得不够清晰和合理，状态机的设计也存在着相当的不合理性。关于将bank的各部分的写使能分开，不要一起写，这个等整个的功能一步一步开发之后再进行重构和关键路径的优化。还有就是假如是两级的流水线，那么如果读和（脏数据）写冲突了，那么就应该是写优先。写数据会比读数据慢一拍，这样的话就刚好碰在一起，就不用读RAM了，只执行写操作，对于读操作直接拿写的数据就好了（好有道理，这不就解决了写相关）。

对于信号func，之后切成流水的时候要注意到流水线中的无效情况，也是就是不是二选一的关系，还需要加入无效。则之后换成write_valid和read_valid信号。

cache这边基本确定，取指和访存最好是三级而非两级，也就是cpu至少是7级流水。

只要是流水，就不得不考虑到数据冲突，对于读将要写的似乎显得容易解决，但是如果是考虑到WriteBuffer，似乎一切都不是那么简单。写WriteBuffer的时候也有可能同时在读，其中会不会出现数据冲突呢？所以在构建流水之前还是需要先思考一下Cache中的数据通路，准确而优雅的展示出硬件框图和其中的联系关系。

#### 状态机非流水思考

##### 状态机

现在的状态机基本符合预期，但是在Look Up和Write Data两个状态没有太多的操作，很多操作都在fetch data中，其中写ram的操作也在这里完成，因此可以考虑之后从中分配一部分操作出去。

##### ram

稍后将ram变成simple-dual模式。

##### Write Collision

在Write Buffer中出现一个非常诡异的现象，就是当写命中正在写入的块的时候，不能够算写命中啊喂！这个导致hit在读写情况下是不同的，所以要格外注意。现在采取的方式就是直接将这种情况下的命中去除，不算写命中，但是后期可以思考一下是否会有更好的解决方案。

但是同时如果是前面所述的情况下出现了读双命中 ，那就非常麻烦。很明显我们只能取之后进来的数据，但是这样的话从设计来说就意味着设计的难度大大增加。现在发现，不仅会出现读双命中，还会出现写双命中，这就意味着有问题，这样牵扯出来的问题规模超出了我们能够接受的复杂度，因此我们将重新设计我们的WriteBuffer。

清华采取的措施是refill，也就是如果出现了这样的写冲突，那么在其写完之后进行重新写入。但是清华并不是像我们一样将FIFO尽可能独立出来，而是用DCache去严格管理，这样的设计耦合度十分大，不利于开发和验证。

Cache中的数据通路是以块为大小设计的，也就是意味着读写一个字的时候通常需要用到一个块大大小的线路，这大大增加了接线数量，或许可以考虑之后的优化，将不必要的接线去除。

#### 结构设计文档

对于cache的结构和设计的思想的文档都在Cache_Design.md中，但是里面目前的不仅不全面而且有部分未更新，并且排版偏向混乱，至于具体的结构设计文档，包括硬件框图，都会在单发射性能测试成功后或者是双发射性能测试成功之后进行补充。为了方便团队内部和之后学校内部的传承，这都是必须要做的事情。

至于开源版本，可能会有一定设计上的精简，考虑到整个比赛的良性循环以及学习精神，开源版本应该附加的Cache Design更加注重原理上而非细节上的设计，这两个版本将为校内同学的学习提供Cache设计的参考。

#### 紧接着要做的事情

- DCache仿真

#### 剩余待实现的功能

- 流水切割（初具成果的cache）
- Cache指令
- 硬件初始化（决赛的基本要求）
- 指令预取
- 双发射（最终成品的cache的基础版）
- 开发文档和结构设计的撰写
- 这之后就是各种提升性能的关键所在了


