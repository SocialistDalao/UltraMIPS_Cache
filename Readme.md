# Cache开发说明

当前目录下为半成品的ICache，有一个未完成的非常低级的DCache。

ICache的输入输出接口均为半成品，能够支持完成一定的功能，但是不能够进行完整的接口配置。其内部功能已经初步仿真正确，可综合验证。DCache的功能已经初具成果。

#### 流水线思考思考



DCache的一部分遗留问题如下：首先是结构和状态机不能够与流水线进行对接，同时整个流水线的结构显得扑朔迷离，不仅如此，当前的代码和数据通路的构造显得不够清晰和合理，状态机的设计也存在着相当的不合理性。关于将bank的各部分的写使能分开，不要一起写，这个等整个的功能一步一步开发之后再进行重构和关键路径的优化。还有就是假如是两级的流水线，那么如果读和（脏数据）写冲突了，那么就应该是写优先。写数据会比读数据慢一拍，这样的话就刚好碰在一起，就不用读RAM了，只执行写操作，对于读操作直接拿写的数据就好了（好有道理，这不就解决了写相关）。

对于信号func，之后切成流水的时候要注意到流水线中的无效情况，也是就是不是二选一的关系，还需要加入无效。则之后换成write_valid和read_valid信号。

cache这边基本确定，取指和访存最好是三级而非两级，也就是cpu至少是7级流水。

现在的下一个目标：~~实现脏标志的正确赋值~~，脏数据的正确弹出（读不命中），脏数据写入内存。现在暂时还不考虑切流水，首先是功能第一，其次是现在双发射那边还没有做出来，不知道到时候到底是什么一个工序。

#### 状态机非流水思考

现在感觉脏逻辑里头，有一些不应该使用时序逻辑的东西，看看是不是有点问题，用组合逻辑比较好。

虚实逻辑中，到底什么时候用物理地址什么时候用虚拟地址，又怎么样尽量绕开虚实转换减少延时，这是个问题。

现在发现scan cache状态直接就是读命中的输出状态，感觉这和名字不搭啊，状态机的设计有点问题。

#### 结构设计文档

对于cache的结构和设计的思想的文档都在Cache_Design.md中，但是里面目前的不仅不全面而且有部分未更新，并且排版偏向混乱，至于具体的结构设计文档，包括硬件框图，都会在单发射性能测试成功后或者是双发射性能测试成功之后进行补充。为了方便团队内部和之后学校内部的传承，这都是必须要做的事情。

至于开源版本，可能会有一定设计上的精简，考虑到整个比赛的良性循环以及学习精神，开源版本应该附加的Cache Design更加注重原理上而非细节上的设计，这两个版本将为校内同学的学习提供Cache设计的参考。

#### 紧接着要做的事情

- FIFO的仿真
- FIFO输入的信号命名不应该是cpu而是cache
- Cache在同一时间只能是读或者写，所以
- FIFO接入DCache
- Cache目前的状态设计问题
- FIFO的写入与cpu的写入不同步，需要先判定是否需要写入FIFO（即写命中的判断）
- FIFO写逻辑有问题，首先要读不命中，才会写进去，那么写的块不可能会出现在FIFO中。写不命中的时候转换为从总线中读数据，然后写。
- FIFO满的时候，若此时要写入就要使得Cache停止工作

#### 剩余待实现的功能

- DCache
- 写回型store的实现
- 写入缓冲FIFO
- 总线块打包（完整的cache）
- 流水切割（初具成果的cache）
- Cache指令
- 硬件初始化（决赛的基本要求）
- 指令预取
- 双发射（最终成品的cache的基础版）
- 开发文档和结构设计的撰写
- 这之后就是各种提升性能的关键所在了